#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR_DEFAULT="$(cd "$SCRIPT_DIR/.." && pwd)"
ROOT_DIR="${PI_STATUSBAR_ROOT:-$ROOT_DIR_DEFAULT}"

if [[ ! -f "$ROOT_DIR/daemon/pi_statusd.py" ]]; then
  if [[ -f "$SCRIPT_DIR/../libexec/pi-statusbar/daemon/pi_statusd.py" ]]; then
    ROOT_DIR="$SCRIPT_DIR/../libexec/pi-statusbar"
  fi
fi

STATUSDCTL="$ROOT_DIR/daemon/statusdctl"
DAEMON="$ROOT_DIR/daemon/pi_statusd.py"
STATE_DIR="$HOME/.pi/agent"
LAUNCH_AGENTS_DIR="$HOME/Library/LaunchAgents"
PLIST_PATH="$LAUNCH_AGENTS_DIR/dev.jademind.pi-statusd.plist"
LABEL="dev.jademind.pi-statusd"

mkdir -p "$STATE_DIR" "$LAUNCH_AGENTS_DIR"

assert_layout() {
  if [[ ! -f "$STATUSDCTL" ]]; then
    echo "Could not locate statusdctl at: $STATUSDCTL"
    echo "Set PI_STATUSBAR_ROOT to your repo/install root."
    exit 1
  fi
  if [[ ! -f "$DAEMON" ]]; then
    echo "Could not locate daemon script at: $DAEMON"
    echo "Set PI_STATUSBAR_ROOT to your repo/install root."
    exit 1
  fi
}

service_target() {
  echo "gui/$(id -u)"
}

is_loaded() {
  launchctl print "$(service_target)/$LABEL" >/dev/null 2>&1
}

install_plist() {
  assert_layout
  cat > "$PLIST_PATH" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
  <dict>
    <key>Label</key>
    <string>$LABEL</string>

    <key>ProgramArguments</key>
    <array>
      <string>/usr/bin/env</string>
      <string>python3</string>
      <string>$DAEMON</string>
    </array>

    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>

    <key>WorkingDirectory</key>
    <string>$ROOT_DIR</string>

    <key>StandardOutPath</key>
    <string>$STATE_DIR/statusd.log</string>
    <key>StandardErrorPath</key>
    <string>$STATE_DIR/statusd.log</string>

    <key>EnvironmentVariables</key>
    <dict>
      <key>PYTHONUNBUFFERED</key>
      <string>1</string>
      <key>PI_STATUSBAR_ROOT</key>
      <string>$ROOT_DIR</string>
    </dict>
  </dict>
</plist>
EOF
  chmod 0644 "$PLIST_PATH"
  echo "Installed LaunchAgent plist: $PLIST_PATH"
}

remove_plist() {
  rm -f "$PLIST_PATH"
  echo "Removed LaunchAgent plist: $PLIST_PATH"
}

start_service() {
  install_plist
  if is_loaded; then
    launchctl kickstart -k "$(service_target)/$LABEL"
    echo "Restarted $LABEL"
  else
    launchctl bootstrap "$(service_target)" "$PLIST_PATH"
    echo "Started $LABEL"
  fi

  if "$STATUSDCTL" ensure >/dev/null 2>&1; then
    echo "pi-statusd is healthy"
  else
    echo "pi-statusd failed health check; inspect $STATE_DIR/statusd.log"
    exit 1
  fi
}

stop_service() {
  if is_loaded; then
    launchctl bootout "$(service_target)/$LABEL" >/dev/null 2>&1 || true
    echo "Stopped $LABEL"
  else
    echo "$LABEL is not loaded"
  fi

  "$STATUSDCTL" stop >/dev/null 2>&1 || true
}

restart_service() {
  stop_service
  start_service
}

status_service() {
  local rc=0
  if [[ -f "$PLIST_PATH" ]]; then
    echo "registered: yes ($PLIST_PATH)"
  else
    echo "registered: no"
    rc=1
  fi

  if is_loaded; then
    local pid
    pid="$(launchctl print "$(service_target)/$LABEL" 2>/dev/null | awk -F'= ' '/pid =/{print $2; exit}' | tr -d ';')"
    if [[ -n "$pid" && "$pid" != "0" ]]; then
      echo "loaded: yes (pid $pid)"
    else
      echo "loaded: yes"
    fi
  else
    echo "loaded: no"
    rc=1
  fi

  if "$STATUSDCTL" status >/dev/null 2>&1; then
    echo "daemon health: healthy"
  else
    echo "daemon health: unhealthy"
    rc=1
  fi

  return "$rc"
}

doctor_service() {
  status_service || true
  echo
  echo "--- launchctl (tail) ---"
  launchctl print "$(service_target)/$LABEL" 2>/dev/null | tail -n 30 || true
  echo
  echo "--- statusd log (tail) ---"
  tail -n 30 "$STATE_DIR/statusd.log" 2>/dev/null || true
}

show_help() {
  cat <<'EOF'
Usage: daemon/statusd-service <command>

Commands:
  install       Create/update LaunchAgent plist only
  uninstall     Unload service (if loaded) and remove plist
  start         Install plist if needed, bootstrap LaunchAgent, and health-check daemon
  stop          Stop LaunchAgent and any fallback daemon process
  restart       Restart LaunchAgent + health-check
  status        Show registered/loaded/healthy state
  doctor        Status + launchctl/log tails
EOF
}

cmd="${1:-status}"
case "$cmd" in
  install)
    install_plist
    ;;
  uninstall)
    stop_service
    remove_plist
    ;;
  start)
    start_service
    ;;
  stop)
    stop_service
    ;;
  restart)
    restart_service
    ;;
  status)
    status_service
    ;;
  doctor)
    doctor_service
    ;;
  *)
    show_help
    exit 2
    ;;
esac
