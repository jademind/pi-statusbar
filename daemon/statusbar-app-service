#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR_DEFAULT="$(cd "$SCRIPT_DIR/.." && pwd)"
ROOT_DIR="${PI_STATUSBAR_ROOT:-$ROOT_DIR_DEFAULT}"

LAUNCH_AGENTS_DIR="$HOME/Library/LaunchAgents"
PLIST_PATH="$LAUNCH_AGENTS_DIR/dev.jademind.PiStatusBar.plist"
LABEL="dev.jademind.PiStatusBar"
STATE_DIR="$HOME/.pi/agent"
LOG_FILE="$STATE_DIR/PiStatusBar.log"

mkdir -p "$LAUNCH_AGENTS_DIR" "$STATE_DIR"

service_target() {
  echo "gui/$(id -u)"
}

is_loaded() {
  launchctl print "$(service_target)/$LABEL" >/dev/null 2>&1
}

resolve_program_arguments() {
  local app_bin
  app_bin="$(command -v PiStatusBar || true)"
  if [[ -n "$app_bin" ]]; then
    echo "$app_bin"
    return 0
  fi

  if [[ -x "$ROOT_DIR/.build/debug/PiStatusBar" ]]; then
    echo "$ROOT_DIR/.build/debug/PiStatusBar"
    return 0
  fi

  echo ""
}

install_plist() {
  local app_bin
  app_bin="$(resolve_program_arguments)"

  if [[ -n "$app_bin" ]]; then
    cat > "$PLIST_PATH" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
  <dict>
    <key>Label</key>
    <string>$LABEL</string>

    <key>ProgramArguments</key>
    <array>
      <string>$app_bin</string>
    </array>

    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <false/>

    <key>WorkingDirectory</key>
    <string>$ROOT_DIR</string>

    <key>StandardOutPath</key>
    <string>$LOG_FILE</string>
    <key>StandardErrorPath</key>
    <string>$LOG_FILE</string>

    <key>EnvironmentVariables</key>
    <dict>
      <key>PI_STATUSBAR_ROOT</key>
      <string>$ROOT_DIR</string>
    </dict>
  </dict>
</plist>
EOF
  else
    cat > "$PLIST_PATH" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
  <dict>
    <key>Label</key>
    <string>$LABEL</string>

    <key>ProgramArguments</key>
    <array>
      <string>/usr/bin/env</string>
      <string>swift</string>
      <string>run</string>
      <string>--package-path</string>
      <string>$ROOT_DIR</string>
      <string>PiStatusBar</string>
    </array>

    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <false/>

    <key>WorkingDirectory</key>
    <string>$ROOT_DIR</string>

    <key>StandardOutPath</key>
    <string>$LOG_FILE</string>
    <key>StandardErrorPath</key>
    <string>$LOG_FILE</string>

    <key>EnvironmentVariables</key>
    <dict>
      <key>PI_STATUSBAR_ROOT</key>
      <string>$ROOT_DIR</string>
    </dict>
  </dict>
</plist>
EOF
  fi

  chmod 0644 "$PLIST_PATH"
  echo "Installed LaunchAgent plist: $PLIST_PATH"
}

start_service() {
  install_plist
  if is_loaded; then
    launchctl kickstart -k "$(service_target)/$LABEL"
    echo "Restarted $LABEL"
  else
    launchctl bootstrap "$(service_target)" "$PLIST_PATH"
    echo "Started $LABEL"
  fi
}

stop_service() {
  if is_loaded; then
    launchctl bootout "$(service_target)/$LABEL" >/dev/null 2>&1 || true
    echo "Stopped $LABEL"
  else
    echo "$LABEL is not loaded"
  fi
  pkill -f "PiStatusBar" >/dev/null 2>&1 || true
}

status_service() {
  local rc=0
  if [[ -f "$PLIST_PATH" ]]; then
    echo "registered: yes ($PLIST_PATH)"
  else
    echo "registered: no"
    rc=1
  fi

  if is_loaded; then
    local pid
    pid="$(launchctl print "$(service_target)/$LABEL" 2>/dev/null | awk -F'= ' '/pid =/{print $2; exit}' | tr -d ';')"
    if [[ -n "$pid" && "$pid" != "0" ]]; then
      echo "loaded: yes (pid $pid)"
    else
      echo "loaded: yes"
    fi
  else
    echo "loaded: no"
    rc=1
  fi

  if pgrep -x PiStatusBar >/dev/null 2>&1 || pgrep -f "swift.*PiStatusBar" >/dev/null 2>&1; then
    echo "app process: running"
  else
    echo "app process: not running"
    rc=1
  fi
  return "$rc"
}

uninstall_service() {
  stop_service
  rm -f "$PLIST_PATH"
  echo "Removed LaunchAgent plist: $PLIST_PATH"
}

show_help() {
  cat <<'EOF'
Usage: statusbar-app-service <command>

Commands:
  install       Create/update app LaunchAgent plist only
  start         Install plist if needed and start app at login/session
  stop          Stop app LaunchAgent and running PiStatusBar processes
  restart       Restart app LaunchAgent
  status        Show registered/loaded/running state
  uninstall     Stop service and remove plist
EOF
}

cmd="${1:-status}"
case "$cmd" in
  install)
    install_plist
    ;;
  start)
    start_service
    ;;
  stop)
    stop_service
    ;;
  restart)
    stop_service
    start_service
    ;;
  status)
    status_service
    ;;
  uninstall)
    uninstall_service
    ;;
  *)
    show_help
    exit 2
    ;;
esac
